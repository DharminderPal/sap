
*&---------------------------------------------------------------------*
*& Include          ZQM_TOP1
*&---------------------------------------------------------------------*

*&---------------------------------------------------------------------*
*& Include ZQM_P_001_TOP                            - Module Pool      ZQM_P_001
*&---------------------------------------------------------------------* DHARMDNER PAL
PROGRAM ZQM40.
INCLUDE ZQM_TOP1    
CONTROLS: TS_1 type TABSTRIP.
DATA : gv_aufnr type AUFM-AUFNR,
       gv_PRUEFLOS TYPE qals-PRUEFLOS, "inspesction lot here  screen1
       gv_PR2 TYPE qals-PRUEFLOS, """screen 2
       gv_aufnr2 type AUFM-AUFNR,
       gv_purchase type AUFM-AUFNR,
       gv_ATWRT type AUSP-ATWRT,
       output type AUSP-ATWRT,
       input type string,
       gv_VORNR type AFVC-VORNR,
       gv_LTXA1 type AFVC-LTXA1,
       gv_op(50) type c,
       gv_binno(10) type c,
       gv_qr(50) type c,
       gv_qr2(50) type c,
       gv_binno2(10) type c,
       gv_qty_bin(50) type c,
       gv_qty_bin2(50) type c,
       gv_next(50) type c,
       gv_GMNGA(50) type c,
       lv_ok type sy-ucomm,
       gv_GAMNG type QALS-LOSMENGE,  """"here picking the quntity
       gv_brgew TYPE qals-KTEXTMAT, ""description
       gv_ntgew TYPE qals-MATNR,
       gv_batch TYPE qals-charg,
       plant TYPE qals-werk,
       ls_header type ZQM_ST_001.

DATA :"lt_atwrt type table of ausp-atwrt,
      gt_ATWRT type vrm_values,
       gt_VORNR type vrm_values,
       gt_GMNGA type vrm_values,
       gt_next type vrm_values,
       GT_op TYPE VRM_VALUES.
DATA : gs_ATWRT type  vrm_value,
       gs_VORNR type vrm_value,
       gs_GMNGA type vrm_value,
       gs_next type vrm_value,
       GS_op TYPE VRM_VALUE.

DATA: f1 type VRM_ID,
      f2 type VRM_ID,
      f3 type VRM_ID,
      f4 type VRM_ID,
      lv_qrcode               TYPE xstring,
      iv_barcode_text         TYPE string VALUE 'Test QR Data'.

      ***************************************************************

      *&---------------------------------------------------------------------*
*& Include          ZQM_O01
*&---------------------------------------------------------------------*

*&---------------------------------------------------------------------*
*& Include          ZQM_P_001_O01
*&---------------------------------------------------------------------*
*&---------------------------------------------------------------------*
*& Module STATUS_9901 OUTPUT
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
MODULE status_9901 OUTPUT.

ENDMODULE.
*&---------------------------------------------------------------------*
*& Module STATUS_9000 OUTPUT
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
MODULE status_9000 OUTPUT.
 SET PF-STATUS 'PF9901'.
 SET TITLEBAR 'TB9901'.

ENDMODULE.
*&---------------------------------------------------------------------*
*& Module STATUS_9902 OUTPUT
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
MODULE status_9902 OUTPUT.

ENDMODULE.
*&---------------------------------------------------------------------*
*& Module LOAD_AUFNR OUTPUT
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
*MODULE load_aufnr OUTPUT.
*  IF gv_aufnr is INITIAL.
*    GET PARAMETER ID 'ANR' FIELD gv_aufnr.
*  ENDIF.
*ENDMODULE.
*&---------------------------------------------------------------------*
*& Module GET_AUFNR OUTPUT
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
MODULE get_aufnr OUTPUT.



ENDMODULE.
*&---------------------------------------------------------------------*
*& Module GET_AUFNR2 OUTPUT
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
MODULE get_aufnr2 OUTPUT.
*IF gv_aufnr2 is INITIAL.
*    GET PARAMETER ID 'ANR' FIELD gv_aufnr2.

*  ENDIF.
ENDMODULE.
 INCLUDE ZQM_O01       


 *&---------------------------------------------------------------------*
*& Include          ZQM_P_001_I01
*&---------------------------------------------------------------------*
*&---------------------------------------------------------------------*
*&      Module  USER_COMMAND_9901  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE user_command_9901 INPUT.


*clear GV_AUFNR2.
*CLEAR GV_BINNO2.
*CLEAR GV_QTY_BIN2.
  CASE lv_ok.

       WHEN 'PB_SAVE'.
      PERFORM SAVE.
  ENDCASE.
ENDMODULE.
*&---------------------------------------------------------------------*
*&      Module  USER_COMMAND_9000  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE user_command_9000 INPUT.
*BREAK-POINT.
  CASE lv_ok.
    WHEN 'BACK' OR 'EXIT' OR 'CLOSE' .
      LEAVE TO SCREEN 0.
    WHEN 'FCT_1'.
      ts_1-activetab = 'FCT_1'.
    WHEN 'FCT_2'.
      ts_1-activetab = 'FCT_2'.


  ENDCASE.

ENDMODULE.
*&---------------------------------------------------------------------*
*&      Module  USER_COMMAND_9902  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE user_command_9902 INPUT.

  CASE lv_ok.
    WHEN 'PB_PRINT'.
      PERFORM PRINT.
  ENDCASE.

ENDMODULE.
*&---------------------------------------------------------------------*
*&      Module  SAVE_AUFNR  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE save_aufnr INPUT.

  SET PARAMETER ID 'ANR' FIELD gv_aufnr.

ENDMODULE.
*&---------------------------------------------------------------------*
*&      Module  CHECK_AUFNR  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE check_aufnr INPUT.

  IF gv_PRUEFLOS NE  gv_PR2.
  CLEAR Gv_ATWRT.
  CLEAR Gv_OP.
  CLEAR Gv_GMNGA.
  ENDIF.


* SET PARAMETER ID 'ANR' FIELD gv_aufnr.
   gv_PR2 = gv_PRUEFLOS.
  gv_qty_bin2 = gv_qty_bin.
  gv_brgew = gv_brgew.
  gv_ntgew = gv_ntgew.
  gv_binno2 = gv_binno.
  gv_qr2     = gv_qr.
*  gv_aufnr = gv_aufnr2.
ENDMODULE.
*&---------------------------------------------------------------------*
*&      Module  CHECK_AUFNR2  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE check_aufnr2 INPUT.
*SET PARAMETER ID 'ANR' FIELD gv_aufnr2.

  CLEAR  gv_PR2.
  CLEAR GV_BINNO2.
  CLEAR GV_QTY_BIN2.
  clear  gv_PR2.
*  gv_AUFNR = gv_aufnr2.
   gv_PR2 = gv_PRUEFLOS.
  gv_qty_bin2 = gv_qty_bin.
  gv_binno2 = gv_binno.
  gv_qr2     = gv_qr.

ENDMODULE.


 INCLUDE ZQM_I01     








 INCLUDE ZQM_F01    



*&---------------------------------------------------------------------*
*& Include          ZQM_F01
*&---------------------------------------------------------------------*


*&---------------------------------------------------------------------*
*& Include          ZQM_P_001_F01
*&---------------------------------------------------------------------*
*&---------------------------------------------------------------------*
*&      Module  FETCH_DATA  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE fetch_data INPUT.
  CLEAR gt_GMNGA.
  CLEAR gt_atwrt.
  CLEAR GT_op.
  CLEAR gt_vornr.


  CALL FUNCTION 'CONVERSION_EXIT_ATINN_INPUT'
    EXPORTING
      input  = 'HEAT_NUMBER'
    IMPORTING
      output = output.

*  SELECT DISTINCT ausp~atwrt
*    INTO TABLE @DATA(lt_atwrt)
*  FROM Aufm
*          LEFT JOIN mch1 AS mch1 ON mch1~charg = aufm~charg AND aufm~bwart = '261'
*          LEFT JOIN ausp AS ausp ON ausp~objek = mch1~cuobj_bm AND ausp~atinn = @output
*          LEFT join qals on qals~PRUEFLOS = @gv_PRUEFLOS
*   WHERE aufm~aufnr = @qals~aufnr.
*BREAK-POINT.












SELECT DISTINCT s~atwrt
  INTO TABLE @DATA(lt_atwrt)
  FROM aufm AS a
  LEFT JOIN mch1 AS m
    ON m~charg = a~charg
   AND a~bwart = '261'
  LEFT JOIN ausp AS s
    ON s~objek = m~cuobj_bm
   AND s~atinn = @output
  INNER JOIN qals AS q
    ON q~aufnr   = a~aufnr
 WHERE q~prueflos = @gv_prueflos.


  LOOP AT lt_atwrt INTO DATA(ls_atwrt).

    CLEAR gs_atwrt.
    gs_atwrt-key  = ls_atwrt-atwrt.
    gs_atwrt-text = ls_atwrt-atwrt.
    APPEND gs_atwrt TO gt_atwrt.
  ENDLOOP.


*************************edited by zaid************
  SELECT DISTINCT afvc~vornr, afvc~ltxa1 INTO TABLE @DATA(lt_VORNR) FROM afko AS afko
  INNER JOIN afvc AS afvc ON afvc~aufpl = afko~aufpl WHERE afko~aufnr = @gv_AUFNR.

  LOOP AT lt_VORNR INTO DATA(ls_vornr).

    CLEAR gs_vornr.
    gs_vornr-key  = |{ ls_vornr-vornr } { ls_vornr-ltxa1 } |.
    gs_vornr-text = |{ ls_vornr-vornr } { ls_vornr-ltxa1 } |.
    APPEND gs_vornr TO gt_vornr.
  ENDLOOP.

*********************************ended*****************************
  SELECT DISTINCT  gmnga INTO TABLE @DATA(lt_GMNGA) FROM afru WHERE afru~aufnr = @gv_AUFNR.

  LOOP AT lt_GMNGA INTO DATA(ls_GMNGA).

    CLEAR gs_GMNGA.
    gs_GMNGA-key  = ls_GMNGA-gmnga && ' '.
    gs_GMNGA-text = ls_GMNGA-gmnga && ' '.
    APPEND gs_GMNGA TO gt_GMNGA.
  ENDLOOP.
  DATA: lv_templtxa1 TYPE ltxa1.
  CLEAR gv_next.

*  IF gv_atwrt(4) NE 0.
*    lv_templtxa1 = gv_op(4) + 010 .
*  ENDIF.

  CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
    EXPORTING
      input  = lv_templtxa1
    IMPORTING
      output = lv_templtxa1.
  SELECT SINGLE afvc~ltxa1  FROM afko AS afko
   INNER JOIN afvc AS afvc ON afvc~aufpl = afko~aufpl AND  afvc~vornr = @lv_templtxa1 WHERE afko~aufnr = @gv_AUFNR INTO  @DATA(lt_next).
  gv_next = lt_next.
  CLEAR lt_next.

*  SELECT SINGLE afko~gamng INTO @DATA(ls_qty) FROM afko WHERE afko~aufnr = @gv_AUFNR.
*  gv_GAMNG = ls_qty.

  SELECT SINGLE  QALS~LOSMENGE INTO @DATA(ls_qty) FROM QALS WHERE QALS~PRUEFLOS = @gv_PRUEFLOS
    .
  gv_GAMNG = ls_qty.
 SELECT SINGLE  QALS~KTEXTMAT INTO @DATA(ls_dis) FROM QALS WHERE QALS~PRUEFLOS = @gv_PRUEFLOS
    .
  gv_brgew = ls_dis.
 SELECT SINGLE  QALS~MATNR INTO @DATA(ls_mis) FROM QALS WHERE QALS~PRUEFLOS = @gv_PRUEFLOS
    .
  gv_ntgew = ls_mis.


  SELECT SINGLE qals~CHARG into @data(batch) FROM qals where QALS~PRUEFLOS = @gv_PRUEFLOS.

 gv_batch = batch.

 SELECT SINGLE qals~werk into @data(plant1) FROM qals where QALS~PRUEFLOS = @gv_PRUEFLOS.

 plant = plant1.


ENDMODULE.
*&---------------------------------------------------------------------*
*&      Module  F4_HEATNO  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE f4_heatno OUTPUT.
  f1 = 'gv_ATWRT'.
  CALL FUNCTION 'VRM_SET_VALUES'
    EXPORTING
      id     = f1
      values = gt_atwrt.


ENDMODULE.
*&---------------------------------------------------------------------*
*&      Module  F4_OPERATION  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE f4_operation OUTPUT.

  SORT gt_vornr BY key.
  f2 = 'gv_op'.
  CALL FUNCTION 'VRM_SET_VALUES'
    EXPORTING
      id     = f2
      values = gt_vornr.


ENDMODULE.
*&---------------------------------------------------------------------*
*&      Module  F4_QUANTITY  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE f4_quantity OUTPUT.
*    f3 = 'gv_GMNGA'.
*  CALL FUNCTION 'VRM_SET_VALUES'
*    EXPORTING
*      id     = f3
*      values = GT_GMNGA.

  CALL FUNCTION 'VRM_SET_VALUES'
    EXPORTING
      id              = 'GV_GMNGA'
      values          = gt_gmnga
    EXCEPTIONS
      id_illegal_name = 1
      OTHERS          = 2.
  IF sy-subrc <> 0.
* Implement suitable error handling here
  ENDIF.


ENDMODULE.
*&---------------------------------------------------------------------*
*& Module F4_NEXT OUTPUT
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
MODULE f4_next OUTPUT.
  f4 = 'gv_next'.
  CALL FUNCTION 'VRM_SET_VALUES'
    EXPORTING
      id     = f4
      values = GT_next.

ENDMODULE.
*&---------------------------------------------------------------------*
*& Form SAVE
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM save .

  DATA lt_temp TYPE  TABLE OF zqm_t_001.
  SELECT SINGLE t001w~name1 , T001w~name2 , afpo~matnr, makt~maktx , mara~brgew , mara~ntgew FROM afpo AS afpo
  LEFT JOIN t001w AS t001w ON T001w~werks = afpo~dwerk
  LEFT JOIN mara ON afpo~matnr = mara~matnr
  LEFT JOIN makt AS makt ON makt~matnr = afpo~matnr WHERE afpo~aufnr = @gv_AUFNR INTO @DATA(ls_temp).
*
  APPEND VALUE #(

  aufnr    = gv_AUFNR
  atwrt    = gv_ATWRT
  operation = gv_op
  "VORNR    = gv_op(4)
  gamng    = gv_GAMNG
  ltxa1    = gv_op+4(*)
  gmnga    = gv_GMNGA
  next_op  = gv_next
  qty_bin  = gv_qty_bin
  quality = gv_qr
  bin_no   = gv_binno
  name1    = ls_temp-name1
  name2    = ls_temp-name2
  matnr    = ls_temp-matnr
  maktx    = ls_temp-maktx

  ) TO lt_temp.


  MODIFY zqm_t_001 FROM TABLE lt_temp.

ENDFORM.

*&---------------------------------------------------------------------*
*& Form PRINT
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*

FORM print .
*BREAK-POINT.
  SELECT SINGLE t001w~name1 , T001w~name2 , afpo~matnr, makt~maktx , mara~brgew ,afru~budat , mara~ntgew , qals~prueflos ,qals~losmenge FROM afpo AS afpo
     LEFT JOIN t001w AS t001w ON T001w~werks = afpo~dwerk
     LEFT JOIN afru ON afpo~aufnr = afru~aufnr
     INNER JOIN mara ON mara~matnr = afpo~matnr
     LEFT JOIN makt AS makt ON makt~matnr = afpo~matnr
    LEFT JOIN qals ON afpo~aufnr =  qals~aufnr AND qals~art = '03'
    WHERE afpo~aufnr = @gv_AUFNR INTO @DATA(ls_temp).
  CLEAR ls_header-budat.

*  SELECT SINGLE budat INTO @ls_header-budat FROM afru WHERE aufnr = @gv_AUFNR AND vornr = @gv_op.

  ls_header-budat    = sy-datum .


  SELECT SINGLE kdauf INTO @DATA(so) FROM resb WHERE aufnr = @gv_AUFNR .
  SELECT SINGLE ihrez INTO @DATA(ih) FROM vbak WHERE vbeln = @so.
*BREAK  abap2. 11.24
  ls_header-atwrt    = gv_ATWRT        .
  ls_header-vornr    = gv_op(4)        .
*  ls_header-gamng    = gv_GAMNG        .
  ls_header-ltxa1    = gv_op+4(*)      .
  ls_header-gmnga    = gv_GMNGA        .
  ls_header-next_op  = gv_next         .
  ls_header-qty_bin  = gv_qty_bin      .
*  ls_header-ntgew    = ls_temp-ntgew * gv_qty_bin.
*  ls_header-brgew    = ls_temp-brgew * gv_qty_bin.
  ls_header-bin_no   = gv_binno        .
  ls_header-name1    = ls_temp-name1   .
  ls_header-name2    = ls_temp-name2    .
  ls_header-matnr    = ls_temp-matnr   .
*ls_header-LOSMENGE = gv_PRUEFLOS.
  ls_header-prueflos = gv_PRUEFLOS.""addede here inspection lot same here in this nwo we habe can be deadd it
  ls_header-losmenge = gv_GAMNG.""""addede here quanitty the data is not coming here
  ls_header-KTEXTMAT = gv_brgew.""
  ls_header-CHARG  =  gv_batch.
  ls_header-MATNR = gv_ntgew.
  ls_header-werk = plant.




*CONCATENATE   ls_header-name2 cl_abap_char_utilities=>newline   INTO iv_barcode_text.

  CONCATENATE gv_AUFNR ih INTO ls_header-powo SEPARATED BY ' / '.
  SELECT SINGLE bwtar FROM mseg INTO @DATA(mb) WHERE aufnr =  @gv_AUFNR and BWART = '261'.
  CONCATENATE ls_header-matnr mb INTO ls_header-partgr SEPARATED BY ' / '.

  ls_header-maktx    = ls_temp-maktx   .
  ls_header-quality  = gv_qr.
*  ls_header-prueflos = ls_temp-prueflos.""addede here inspection lot
*  ls_header-losmenge = ls_temp-losmenge.""""addede here quanitty


  DATA: lv_string TYPE string.
  lv_string = |{ ls_header-gamng }|.
  CONCATENATE ls_header-aufnr cl_abap_char_utilities=>newline
              ls_header-atwrt cl_abap_char_utilities=>newline
              ls_header-vornr cl_abap_char_utilities=>newline
              lv_string cl_abap_char_utilities=>newline
              ls_header-ltxa1 cl_abap_char_utilities=>newline
              ls_header-gmnga cl_abap_char_utilities=>newline
              ls_header-next_op cl_abap_char_utilities=>newline
              ls_header-qty_bin cl_abap_char_utilities=>newline
              ls_header-bin_no cl_abap_char_utilities=>newline
              ls_header-name1 cl_abap_char_utilities=>newline
              ls_header-name2 cl_abap_char_utilities=>newline
              ls_header-matnr cl_abap_char_utilities=>newline
              ls_header-maktx
              INTO iv_barcode_text.

  TRY.
      CALL METHOD cl_rstx_barcode_renderer=>qr_code(
        EXPORTING
          i_module_size      = 3 "40
          i_mode             = 'A' "'A'
          i_error_correction = 'M' "'H'
          i_rotation         = 0
          i_barcode_text     = iv_barcode_text
        IMPORTING
          e_bitmap           = lv_qrcode ).
    CATCH cx_rstx_barcode_renderer.
  ENDTRY.


  DATA:
    ie_outputparams TYPE sfpoutputparams,
    fm_name         TYPE funcname.

  TRY.

      CALL FUNCTION 'FP_JOB_OPEN'
        CHANGING
          ie_outputparams = ie_outputparams
        EXCEPTIONS
          cancel          = 1
          usage_error     = 2
          system_error    = 3
          internal_error  = 4
          OTHERS          = 5.

      CALL FUNCTION 'FP_FUNCTION_MODULE_NAME'
        EXPORTING
          i_name     = 'ZICTAG'
        IMPORTING
          e_funcname = fm_name
*         E_INTERFACE_TYPE           =
*         EV_FUNCNAME_INBOUND        =
        .
    CATCH cx_fp_api_repository
         cx_fp_api_usage
         cx_fp_api_internal INTO DATA(lx_error).
  ENDTRY.

  CALL FUNCTION fm_name
    EXPORTING
*     /1BCDWB/DOCPARAMS        =
      ls_header = ls_header
      lv_qrcode = lv_qrcode
*   IMPORTING
*     /1BCDWB/FORMOUTPUT       =
*   EXCEPTIONS
*     USAGE_ERROR              = 1
*     SYSTEM_ERROR             = 2
*     INTERNAL_ERROR           = 3
*     OTHERS    = 4
    .

  CALL FUNCTION 'FP_JOB_CLOSE'
* IMPORTING
*   E_RESULT             =
    EXCEPTIONS
      usage_error    = 1
      system_error   = 2
      internal_error = 3
      OTHERS         = 4.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Module  F4_PO  INPUT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
MODULE f4_po INPUT.
  DATA: lt_return TYPE TABLE OF ddshretval,  " Stores selected value
        lt_values TYPE TABLE OF aufm-aufnr, " Table for PO numbers
        ls_return TYPE ddshretval.

  SELECT aufnr  FROM aufm INTO TABLE lt_values .


  CALL FUNCTION 'F4IF_INT_TABLE_VALUE_REQUEST'
    EXPORTING
      retfield        = 'AUFNR'    " Field to return
      dynpprog        = sy-repid   " Current program
      dynpnr          = sy-dynnr   " Current screen
      dynprofield     = 'gv_aufnr' " Screen field to update
      value_org       = 'S'        " Value origin (Screen)
    TABLES
      value_tab       = lt_values  " Internal table with values
      return_tab      = lt_return " Selected value table
    EXCEPTIONS
      parameter_error = 1
      no_values_found = 2
      OTHERS          = 3.

  " Assign selected value to screen field
  IF sy-subrc = 0 AND lt_return IS NOT INITIAL.
    READ TABLE lt_return INTO ls_return INDEX 1.
    gv_AUFNR = ls_return-fieldval.
    MODIFY SCREEN.
  ENDIF.

ENDMODULE.


